import subprocess
import json
from .base_power import BaseSuperpower

class VulnerabilityScanPower(BaseSuperpower):

    def get_name(self) -> str:
        return "vulnerability_scan"

    async def execute(self, payload: dict) -> dict:
        """
        Payload should contain:
        - repo_path (string): The local path where the repo is cloned for scanning.
        """
        
        try:
            repo_path = payload.get('repo_path')
            if not repo_path:
                return {"status": "error", "message": "Missing required payload: repo_path"}

            # 1. Define the command to run Google's OSV-Scanner
            # --format=json: Outputs the report as JSON
            # --recursive: Scans all sub-directories
            command = ["osv-scanner", "--format=json", "--recursive", "."]
            
            # 2. Execute the scan
            # We run this command 'inside' the specified repo_path
            result = subprocess.run(
                command, 
                cwd=repo_path, 
                capture_output=True, 
                text=True,
                timeout=300 # 5-minute timeout
            )
            
            # 3. Process the output
            if result.returncode == 0:
                # Success (No vulnerabilities found or just a report)
                try:
                    report = json.loads(result.stdout)
                    return {"status": "success", "report": report, "vulnerabilities_found": len(report.get("results", []))}
                except json.JSONDecodeError:
                    # Handle cases where stdout might be empty but not an error
                    return {"status": "success", "report": "Scan completed. No JSON output.", "vulnerabilities_found": 0}
            else:
                # Error (Vulnerabilities found or scan error)
                # OSV-Scanner often returns a non-zero exit code if vulns are found
                # So we check stdout first
                try:
                    report = json.loads(result.stdout)
                    return {"status": "warning", "report": report, "vulnerabilities_found": len(report.get("results", []))}
                except json.JSONDecodeError:
                    # This is a real error
                    return {"status": "error", "message": "Scan failed", "details": result.stderr}

        except Exception as e:
            return {"status": "error", "message": str(e)}